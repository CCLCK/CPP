

## ğŸŒ²C/C++å†…å­˜åˆ†å¸ƒ

### ğŸŒ´C/C++å†…å­˜åŒºåŸŸåˆ’åˆ† 

![image-20220206235743862](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220206235743862.png)

> æ•°æ®æ®µçš„å¤§å°æ˜¯æ ¹æ®VS2013å¼€çš„å…¨å±€æ•°ç»„æµ‹å‡ºæ¥çš„ï¼Œå¯èƒ½ä¸æ˜¯å¾ˆå‡†

#### ğŸŒµå„åŒºåŸŸåŠŸèƒ½

- å†…æ ¸ï¼šæ“ä½œç³»ç»Ÿä½¿ç”¨çš„ç©ºé—´ï¼Œç”¨æˆ·ä¸èƒ½è¯»å†™

- æ ˆï¼šå±€éƒ¨å˜é‡ï¼Œå±€éƒ¨æ•°ç»„ç­‰éƒ½åœ¨æ ˆï¼Œæ ˆå‘ä¸‹ç”Ÿé•¿ï¼Œå³æ ˆå¾€ä½åœ°å€ç”Ÿé•¿

> constä¿®é¥°çš„å˜é‡å¾—åˆ†æƒ…å†µï¼Œè¿˜å¾—åˆ†cå’Œc++
>
> å‚è€ƒè¿™ä¸ªå¤§ä½¬çš„åšå®¢ğŸ‘‰[constä¿®é¥°çš„å˜é‡çš„å­˜å‚¨ä½ç½®](https://blog.csdn.net/woainilixuhao/article/details/86521357)

- å†…å­˜æ˜ å°„æ®µï¼šä¸ç³»ç»Ÿæœ‰å…³ï¼Œå¾…äº†è§£

- æ•°æ®æ®µï¼ˆé™æ€åŒºï¼‰ï¼šå­˜å‚¨å…¨å±€æ•°æ®å’Œé™æ€æ•°æ®

- ä»£ç æ®µï¼ˆå¸¸é‡åŒºï¼‰ï¼šå¯æ‰§è¡Œä»£ç ï¼ˆäºŒè¿›åˆ¶æŒ‡ä»¤ï¼‰å’Œåªè¯»å¸¸é‡

> constä¿®é¥°çš„æ˜¯å˜é‡ï¼Œæ‰€ä»¥ä¸å«åªè¯»å¸¸é‡

> éšç¬”è®°å½•ï¼š0x7fffffffç›¸å½“äºINT_MAXçš„ä¸€åŠï¼Œ

#### ğŸŒµä¾‹å­

```c++
//å˜é‡åœ¨å†…å­˜é‡Œçš„åˆ†å¸ƒdemo
#include<iostream>
#include<cstdlib>
using namespace std;

//variableçš„æ„æ€æ˜¯å˜é‡ï¼Œvaræ˜¯variableçš„ç®€ç§°
int global_var;//æ•°æ®æ®µ
static int static_global_var;//æ•°æ®æ®µï¼ˆé™æ€åŒºï¼‰
int main()
{
	static int static_var;//æ•°æ®æ®µ
	int local_var;//æ ˆ

	char a[10]="abcd";//aåœ¨æ ˆï¼Œæ•°æ®ä¹Ÿéƒ½åœ¨æ ˆ
	*a;//*aåœ¨æ ˆ
	char* b = "abcd";//båœ¨æ ˆï¼Œæ•°æ®åœ¨ä»£ç åŒºï¼ˆå¸¸é‡åŒºï¼‰
	*b;//*båœ¨ä»£ç åŒº

	int* ptr = (int*)malloc(10);//ptråœ¨æ ˆï¼Œå¼€è¾Ÿçš„ç©ºé—´åœ¨å †
	*ptr;//å †

	return 0;
}
```

![image-20220208114504690](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220208114504690.png)

### ğŸŒ´Cè¯­è¨€ç®¡ç†å†…å­˜çš„æ–¹å¼

é€šè¿‡mallocã€callocã€reallocã€free

- mallocåœ¨å †ä¸Šå¼€è¾Ÿç©ºé—´ï¼Œä½†æ˜¯ä¸åˆå§‹åŒ–
- calloc==malloc+åˆå§‹åŒ–ï¼Œä¸ä»…ä¼šå¼€ç©ºé—´è¿˜ä¼šåˆå§‹åŒ–
- realloc,æ‰©å®¹+æ‹·è´æ•°æ®ï¼Œå¦‚æœç©ºé—´ä¸å¤Ÿéœ€è¦æ‰©å®¹æ—¶å°±ç”¨realloc
- freeé‡Šæ”¾ç©ºé—´ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ç­‰é—®é¢˜

### ğŸŒ´newå’Œdeleteå…³é”®å­—

#### ğŸŒµåˆè¯†

```c++
//åˆå§‹new delete
int main()
{
	//C
	int* ptr = (int*)malloc(sizeof(int));
	free(ptr);
	//C++
	int* pa = new int;
	delete pa;

	return 0;
}
```

![image-20220208123931247](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220208123931247.png)

#### ğŸŒµæ¦‚å¿µ

- ä»€ä¹ˆæ˜¯new?

newæ˜¯C++çš„ä¸€ä¸ªå…³é”®å­—ï¼Œç”¨äºåŠ¨æ€å†…å­˜åˆ†é…

> mallocæ˜¯ä¸€ä¸ªåº“å‡½æ•°

- ä»€ä¹ˆæ˜¯delete?

deleteæ˜¯C++çš„ä¸€ä¸ªå…³é”®å­—ï¼Œç”¨äºé‡Šæ”¾åŠ¨æ€å¼€è¾Ÿçš„å†…å­˜

> ç±»æ¯”free

#### ğŸŒµç®€å•ç”¨æ³•



```c++
//newã€deleteå¯¹äºè‡ªå®šä¹‰ç±»å‹è°ƒç”¨æ„é€ ã€ææ„å‡½æ•°demo
class A
{
public:
	A()
	{
		cout << "A()" << endl;
	}
	~A()
	{
		cout << "~A()" << endl;
	}
};

int main()
{
	A* pa1 = (A*)malloc(sizeof(A));
	free(pa1);
	cout << "malloc å’Œ freeç»“æŸ" << endl;
	cout << endl;

	A* pa2 = new A;
	delete pa2;
	cout << "new å’Œ deleteç»“æŸ" << endl;

	return 0;
}
```

![image-20220208125407000](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220208125407000.png)

> ä»è¿™ä¹Ÿå¯ä»¥çœ‹å‡ºnewå’Œmallocçš„åŒºåˆ«ä¹‹ä¸€å°±æ˜¯ä¼šä¸ä¼šè°ƒç”¨æ„é€ å‡½æ•°ï¼Œdeleteå’Œfreeçš„åŒºåˆ«ä¹‹ä¸€å°±æ˜¯ä¸ä¼šè°ƒç”¨ææ„å‡½æ•°

***

```c++
//newã€deleteå†…ç½®ç±»å‹æ•°ç»„å’Œè‡ªå®šä¹‰ç±»å‹æ•°ç»„
class A
{
public:
	A(){}
	A(int){}

};
int main()
{
	int* ptr = new int[10];//å¼€ä¸€ä¸ªåä¸ªintå¤§å°çš„æ•°ç»„
	delete[] ptr;

	int* ptr2 = new int(5);//å¼€ä¸€ä¸ªintå¤§å°çš„ç©ºé—´å¹¶ä¸”åˆå§‹åŒ–ä¸º5
	delete ptr2;

	A* pa = new A[10];//å¼€ä¸€ä¸ªåä¸ªAç±»å‹å¤§å°çš„æ•°ç»„ï¼Œè°ƒç”¨åæ¬¡æ„é€ å‡½æ•°
	delete[] pa;

	A* pa2 = new A(5);//ä¼šè°ƒç”¨æ„é€ å‡½æ•°A(int)è¿›è¡Œæ„é€ 
	delete pa2;

	return 0;
}
```

![image-20220208132347707](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220208132347707.png)

æ±‡ç¼–è¯æ˜newçš„è¿‡ç¨‹è°ƒç”¨äº†æ„é€ å‡½æ•°

![image-20220208132740988](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220208132740988.png)

> åŸåˆ™ä¸Šnewå’Œdeleteæˆå¯¹ä½¿ç”¨ï¼Œå¦‚æœnewå’Œfreeé…å¯¹ä½¿ç”¨ï¼Œå¯èƒ½é€ æˆç¨‹åºå´©æºƒ.

- æˆ‘ä»¬ä¹‹å‰æœ‰äº†mallocå’Œfreeæ¥åŠ¨æ€å¼€è¾Ÿç©ºé—´ï¼Œé‚£ä¸ºä»€ä¹ˆä¼šå‡ºç°newå’Œdeleteï¼Ÿ

ç­”ï¼š newå’Œmallocåœ¨å¤„ç†å†…ç½®ï¼ˆåŸºæœ¬ï¼‰ç±»å‹ä¸Šæ²¡æœ‰å·®åˆ«ï¼Œéƒ½åªæ˜¯åŠ¨æ€å¼€è¾Ÿä¸€å—ç©ºé—´ï¼Œä½†æ˜¯C++è¿˜æœ‰é¢å‘å¯¹è±¡çš„ç‰¹æ€§ï¼Œåœ¨æˆ‘ä»¬ç»™ä¸€ä¸ªå¯¹è±¡å¼€è¾Ÿç©ºé—´æ—¶ï¼Œè™½ç„¶å¼€è¾Ÿäº†ç©ºé—´ä½†æ˜¯ä¸ä¼šè°ƒç”¨æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ï¼Œæ‰€ä»¥å°±å‡ºç°äº†æ›´èƒ½æ»¡è¶³éœ€æ±‚çš„newå’Œdelete

###ğŸŒ´**mallocã€freeå’Œnewã€deleteçš„åŒºåˆ«**

1. mallocå’Œfreeæ˜¯å‡½æ•°ï¼Œnewå’Œdeleteæ˜¯æ“ä½œç¬¦
2. mallocä¸èƒ½å¯¹ç”³è¯·çš„ç©ºé—´åˆå§‹åŒ–ï¼Œnewå¯ä»¥
3. é’ˆå¯¹è‡ªå®šä¹‰ç±»å‹ï¼Œdeleteå¯ä»¥è°ƒç”¨ææ„å‡½æ•°å®Œæˆå¯¹è±¡å†…èµ„æºçš„æ¸…ç†ï¼Œè€Œfreeä¸è¡Œ
4. ç”¨æ³•ä¸Šï¼Œmallocéœ€è¦å¼ºè½¬ç±»å‹å’Œè®¡ç®—ç±»å‹å¤§å°ï¼Œnewä¸éœ€è¦
5. å¯¹äºé”™è¯¯çš„å¤„ç†ï¼Œmallocå¼€è¾Ÿå¤±è´¥è¿”å›ç©ºæŒ‡é’ˆï¼Œè€Œnewç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œéœ€è¦å¯¹å¼‚å¸¸è¿›è¡Œæ•è·

### ğŸŒ´operator newå’Œoperator delete

- operator newå’Œoperator deleteæ˜¯ä¸¤ä¸ªå…¨å±€å‡½æ•°ï¼Œè€Œä¸æ˜¯è¿ç®—ç¬¦é‡è½½
- newåº•å±‚è°ƒç”¨operator newå¼€è¾Ÿç©ºé—´
- deleteåº•å±‚è°ƒç”¨operator newé‡Šæ”¾ç©ºé—´
- void* operator new(size_t)å’Œvoid operator delete(void* )

####ã€€ğŸŒµoperator newæºç 

è¿™æ®µæºç åœ¨new.cppä¸­

```c++
void *__CRTDECL operator new(size_t size) _THROW1(_STD bad_alloc)
        {       // try to allocate size bytes
        void *p;
        while ((p = malloc(size)) == 0)
                if (_callnewh(size) == 0)
                {       // report no memory
                        _THROW_NCEE(_XSTD bad_alloc, );
                }

        return (p);
        }
```

ç”±æºç å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœè¿”å›çš„æ˜¯ç©ºæŒ‡é’ˆï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸

> ç”±æºç å¯è§operator newä¹Ÿä¸è¿‡æ˜¯å¯¹mallocè¿›è¡Œäº†å°è£…

#### ğŸŒµoperator deleteæºç 

è¿™å—æ²¡æ‰¾åˆ°æºç ï¼Œæ‰¾åˆ°çš„èµ„æ–™å¤§æ¦‚æ„æ€æ˜¯ï¼šoperator deleteè¿™ä¸ªå‡½æ•°ç›¸å½“äºå¯¹freeè¿›è¡Œäº†å°è£…

> ~~å¦‚æœæœ‰å¤§ä½¬çŸ¥é“è¿™ä¸ªå‡½æ•°çš„æºç ä½ç½®ï¼Œéº»çƒ¦å‘Šè¯‰æˆ‘ä¸€ä¸‹ğŸ™~~

> éšç¬”è®°å½•ï¼šoperator deleteé‡Šæ”¾ç©ºæŒ‡é’ˆä¸æŠ¥é”™
>
> ![image-20220211232021376](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220211232021376.png)

#### ğŸŒµoperator newå’Œoperate deleteä¸“å±ç±»é‡è½½

```c++
//ç±»å†…é‡è½½operator newå’Œoperate deleteçš„demo
#include<iostream>
using namespace std;
class A
{
public:
	void* operator new(size_t n)
	{
		cout << "void* operator new(size_t n)" << endl;
		return nullptr;
	}
	void operator delete(void* p)
	{
		cout << "void operator delete(void* p)" << endl;
	}
};

int main()
{
	A* pa=new A;
	delete pa;
	return 0;
}
```

![image-20220211234837813](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220211234837813.png)

### ğŸŒ´newå’ŒdeleteåŸç†

new:è°ƒç”¨operaotr newå‡½æ•°å¼€è¾Ÿç©ºé—´ï¼Œå†åœ¨ç©ºé—´ä¸Šè°ƒç”¨æ„é€ å‡½æ•°

deleteï¼šè°ƒç”¨ææ„å‡½æ•°é‡Šæ”¾ç©ºé—´å†…çš„èµ„æºï¼Œå†è°ƒç”¨operator deleteå‡½æ•°é‡Šæ”¾å¯¹è±¡å¯¹è±¡çš„ç©ºé—´

new T[N]:è°ƒç”¨operator newå¼€è¾Ÿç©ºé—´ï¼Œå†è°ƒç”¨Næ¬¡æ„é€ å‡½æ•°

delete[]:å…ˆæ‰§è¡ŒNæ¬¡ææ„å‡½æ•°ï¼Œå†æŠŠå¼€è¾Ÿçš„å¯¹è±¡ç©ºé—´é‡Šæ”¾æ‰



### ğŸŒ´placement new

#### ğŸŒµå¼•è®º

æˆ‘ä»¬è¯´newä¸mallocçš„ä¸åŒç‚¹ä¹‹ä¸€æ˜¯newä¼šè°ƒç”¨æ„é€ å‡½æ•°

å›é¡¾ä¸€ä¸‹ä¹‹å‰è°ƒç”¨æ„é€ å‡½æ•°çš„æƒ…å½¢ï¼šå®šä¹‰å¯¹è±¡æˆ–è€…newä¸€ä¸ªå¯¹è±¡æ—¶éƒ½ä¼šè°ƒç”¨æ„é€ å‡½æ•°ï¼Œä¸”æ˜¯è‡ªåŠ¨è°ƒç”¨çš„

å¦‚æœæˆ‘ä»¬è¦å¯¹mallocå‡ºæ¥çš„ç©ºé—´æ‰‹åŠ¨è°ƒç”¨æ„é€ å‡½æ•°åº”è¯¥æ€ä¹ˆåŠï¼Ÿ

æ­¤æ—¶å°±éœ€è¦placement new,å³å®šä½newè¡¨è¾¾å¼

#### ğŸŒµç”¨æ³•

placement newä¹Ÿå«å®šä½newè¡¨è¾¾å¼

ä½œç”¨ï¼šåœ¨å·²åˆ†é…çš„ç©ºé—´è°ƒç”¨æ„é€ å‡½æ•°åˆå§‹åŒ–å¯¹è±¡

> æ¯”å¦‚æˆ‘ä»¬mallocåè°ƒç”¨æ„é€ å‡½æ•°åˆå§‹åŒ–å¯¹è±¡

ä½¿ç”¨åœºæ™¯ï¼šå†…å­˜æ± ç­‰

ç”¨æ³•ï¼šnew(æŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆ)ç±»å(æ„é€ å‡½æ•°å‚æ•°)

```c++
//å®šä½newè¡¨è¾¾å¼çš„ç”¨æ³•demo
class A
{
public:
	A()
	{
		cout << "A()"<<endl;
	}
	A(int)
	{
		cout << "A(int)" << endl;
	}
	~A()
	{
		cout << "~A()" << endl;
	}
};
int main()
{
	A* pa = (A*)malloc(sizeof(A));
	new(pa)A;
	//new(pa)A(3);
	pa->~A();
	free(pa);
	return 0;
}
```



![image-20220211233646409](https://pic-1304888003.cos.ap-guangzhou.myqcloud.com/img/image-20220211233646409.png)

## ğŸŒ²æ€»ç»“

- å†…å­˜åŒºåŸŸçš„åˆ’åˆ†ï¼Œå³æ¯å—åŒºåŸŸå¯ä»¥æ”¾ä»€ä¹ˆæ•°æ®ï¼ˆè¯­è¨€å±‚é¢ï¼‰
- newå’Œdeleteå’Œmallocå’Œfreeçš„å·®åˆ«ä¸»è¦åœ¨äºå¯¹è‡ªå®šä¹‰ç±»å‹çš„å¤„ç†ä¸Šï¼Œè¿™ä¸ªå¤„ç†åŒ…æ‹¬å¼€è¾ŸæˆåŠŸå’Œå¼€è¾Ÿå¤±è´¥
- newå’Œdeleteçš„åº•å±‚ä¾èµ–äºoperator new()å’Œoperator delete()ä¸¤ä¸ªå…¨å±€å‡½æ•°
- operator new()å’Œoperator delete()ä¸¤ä¸ªå…¨å±€å‡½æ•°å¯ä»¥ç†è§£ä¸ºæ˜¯å¯¹mallocå’Œfreeè¿›è¡Œäº†ä¸€å±‚å°è£…
- å®šä½newè¡¨è¾¾å¼å¯ä»¥æ‰‹åŠ¨è°ƒç”¨è‡ªå®šä¹‰ç±»å‹çš„æ„é€ å‡½æ•°
- C++æ›´åŠ æ¨èä½¿ç”¨newå’Œdeleteè¿›è¡Œå†…å­˜ç®¡ç†
